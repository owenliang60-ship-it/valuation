# Valuation Agent 设计文档

> 创建日期: 2026-02-03
> 状态: MVP 开发中

## 1. 系统定位

美股大市值股票的数据驱动分析与评级辅助系统。

**核心能力**:
- 投资决策辅助 - 发现值得关注的股票，提供评级建议
- 持仓监控 - 监控已有持仓的风险和变化
- 研究工具 - 生成分析数据，支持人工决策

## 2. 核心架构

```
┌─────────────────────────────────────────────────────┐
│                   交互层 (Interface)                 │
│  - CLI 命令 / Skill 调用                            │
│  - 评级查询、持仓监控、研究报告生成                    │
└─────────────────────────────────────────────────────┘
                         ↓
┌─────────────────────────────────────────────────────┐
│                   分析层 (Analysis)                  │
│  - 可插拔指标引擎 (技术面 + 基本面)                   │
│  - 评级计算器 (DNA建议 + Timing建议)                 │
│  - 信号触发器 (评级变化 → 提醒)                      │
└─────────────────────────────────────────────────────┘
                         ↓
┌─────────────────────────────────────────────────────┐
│                   数据层 (Data)                      │
│  - 股票池管理 (动态进出)                             │
│  - 量价数据 (日频更新)                               │
│  - 基本面数据 (周频/季频更新)                         │
│  - 用户评级存储 (最终决定)                           │
└─────────────────────────────────────────────────────┘
```

## 3. 评级系统 (OPRMS)

双维度评级，参考《机会仓位评级管理系统》:

### Y轴 - 资产基因 (DNA)
决定仓位上限

| 等级 | 名称 | 仓位上限 | 特征 |
|------|------|---------|------|
| S | 圣杯 | 20-25% | 改变人类进程的超级核心资产 |
| A | 猛将 | 15% | 强周期龙头，细分赛道霸主 |
| B | 黑马 | 7% | 强叙事驱动，赔率高但不确定 |
| C | 跟班 | 2% | 补涨逻辑，基本不做 |

### X轴 - 时机系数 (Timing)
决定执行力度

| 等级 | 名称 | 系数 | 特征 |
|------|------|------|------|
| S | 千载难逢 | 1.0-1.5 | 历史性时刻，暴跌坑底/突破 |
| A | 趋势确立 | 0.8-1.0 | 主升浪确认，右侧突破 |
| B | 正常波动 | 0.4-0.6 | 回调支撑，震荡 |
| C | 垃圾时间 | 0.1-0.3 | 左侧磨底，无催化剂 |

### 核心公式
```
最终仓位 = 总资产 × DNA上限 × Timing系数
```

## 4. 数据层设计

### 目录结构
```
data/
├── pool/                    # 股票池管理
│   ├── universe.json        # 当前股票池
│   └── pool_history.json    # 进出记录
│
├── price/                   # 量价数据 (日频)
│   └── {SYMBOL}.csv         # 每只股票一个文件
│
├── fundamental/             # 基本面数据 (周频/季频)
│   ├── profiles.json        # 公司概况
│   ├── ratios.json          # 财务比率
│   └── income.json          # 收入数据
│
└── ratings/                 # 评级数据
    ├── dna_ratings.json     # DNA评级 (用户设定)
    └── timing_ratings.json  # Timing评级 (系统建议+用户覆盖)
```

### 更新频率

| 数据类型 | 频率 | 触发时间 |
|---------|------|---------|
| 股票池 | 周频 | 周末 |
| 量价数据 | 日频 | 美东 16:30 后 |
| 基本面 | 周频/季频 | 周末 / 财报季后 |
| 评级 | 事件驱动 | 手动 / 系统建议 |

### 数据源
- **FMP API** (financialmodelingprep.com)
- API Key 存储: 环境变量 `FMP_API_KEY`
- Base URL: `https://financialmodelingprep.com/stable`

## 5. 分析层设计

### 指标引擎 (可插拔)

统一接口:
```python
def indicator_xxx(symbol: str, price_df: pd.DataFrame, fundamental: dict) -> dict:
    """
    返回:
    {
        "value": 数值,
        "signal": "bullish" | "bearish" | "neutral",
        "description": "说明"
    }
    """
```

### 评级建议器

- DNA 建议: 基于基本面数据 (市值、行业地位、护城河指标)
- Timing 建议: 基于量价数据 (趋势、动量、支撑阻力)

用户可覆盖系统建议，最终评级以用户设定为准。

## 6. MVP 范围

### 包含
- [x] 股票池动态维护 (市值 > $1000亿)
- [x] 量价数据日频更新
- [x] 基本面数据周频更新
- [x] 2-3 个示例指标
- [x] CLI 查询命令

### 不包含 (后续迭代)
- [ ] 新闻数据抓取
- [ ] 自动提醒通知
- [ ] 完整报告生成
- [ ] 完整指标库

## 7. 技术规范

参考 skills:
- `quant-development` - 数据采集、缓存管理、定时任务
- `financial-analysis` - 估值分析方法论

关键原则:
- 代码复用优先，不重复造轮子
- 串行执行 API 调用，间隔 2 秒防限流
- 数据预检查，确保数据新鲜度
- CSV 格式存储量价，JSON 格式存储其他

## 8. 迭代计划

1. **Phase 1 (当前)**: 数据层 MVP
2. **Phase 2**: 分析层 + 示例指标
3. **Phase 3**: 交互层 CLI
4. **Phase 4**: 评级系统完善
5. **Phase 5**: 新闻追踪 + 自动提醒
